<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistem Konsultasi</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
      :root { --primary-blue: #0d6efd; --secondary-blue: #e7f1ff; --light-bg: #f7f9fc; --dark-text: #212529; --gray-text: #6c757d; --border-color: #dee2e6; --success-color: #198754; --danger-color: #dc3545; --warning-color: #ffc107; --white-color: #fff; --shadow: 0 10px 30px rgba(0, 0, 0, 0.07); }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
      body { background-color: var(--light-bg); font-family: 'Inter', sans-serif; color: var(--dark-text); display: flex; flex-direction: column; min-height: 100vh; }
      #mainContainer { width: 100%; transition: max-width 0.3s ease-in-out; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
      .container-login { max-width: 480px; }
      .content-card { display: none; padding: 2.5rem; background-color: var(--white-color); border-radius: 1rem; border: 1px solid var(--border-color); box-shadow: var(--shadow); animation: fadeIn 0.5s ease-out forwards; }
      .role-badge { font-weight: 500; font-size: 0.75rem; padding: 0.3em 0.6em; vertical-align: middle; margin-left: 8px; background-color: var(--secondary-blue); color: var(--primary-blue); border: 1px solid var(--primary-blue); }
      .form-label { font-weight: 500; color: var(--gray-text); }
      .form-control, .form-select { border-radius: 0.5rem; padding: 0.75rem 1rem; border: 1px solid var(--border-color); }
      .form-control:focus, .form-select:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15); }
      h2, h3 { color: var(--dark-text); font-weight: 600; display: flex; align-items: center; gap: 0.75rem;}
      h2 .bi, h3 .bi { font-size: 1.1em; color: var(--primary-blue);}
      .btn { border-radius: 0.5rem; padding: 0.6rem 1.25rem; font-weight: 600; transition: all 0.2s ease; }
      .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
      .table { vertical-align: middle; }
      .list-group-item-action { cursor: pointer; }
      .list-group-item-action:hover { background-color: var(--secondary-blue); }
      .stat-card { background-color: var(--white-color); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); text-align: center; }
      .stat-card .stat-icon { font-size: 2.2rem; margin-bottom: 0.75rem; color: var(--primary-blue); display: block; }
      .stat-card .stat-value { font-size: 2rem; font-weight: 700; color: var(--dark-text); }
      .stat-card .stat-label { font-size: 0.9rem; color: var(--gray-text); font-weight: 500; }
      .admin-sub-card { border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: var(--shadow-sm); }
      .login-logo { max-width: 120px; margin-bottom: 1rem; }
      .app-footer { width: 100%; padding: 1.5rem 0; background-color: var(--white-color); border-top: 1px solid var(--border-color); color: var(--gray-text); font-size: 0.9rem; flex-shrink: 0; }
      /* Chat Styles */
      .chat-body { height: 55vh; overflow-y: auto; padding: 1.5rem; background-color: var(--light-bg); }
      .chat-message { display: flex; margin-bottom: 1rem; }
      .chat-message .message-content { padding: 0.75rem 1.25rem; border-radius: 1rem; max-width: 75%; }
      .chat-message.sender .message-content { background-color: var(--primary-blue); color: var(--white-color); border-bottom-right-radius: 0.25rem; }
      .chat-message.receiver .message-content { background-color: var(--white-color); border: 1px solid var(--border-color); border-bottom-left-radius: 0.25rem; }
      .chat-message.sender { justify-content: flex-end; }
      .chat-message.receiver { justify-content: flex-start; }
      .message-meta { font-size: 0.75rem; margin-top: 0.25rem; color: var(--gray-text); }
      .chat-message.sender .message-meta { text-align: right; }
    </style>
  </head>
  <body>

    <main id="mainContainer" class="container-login">
      <!-- HALAMAN LOGIN -->
      <div id="loginView" class="content-card text-center" style="display: block;">
        <img src="https://cdn-icons-png.flaticon.com/512/8201/8201170.png" alt="Logo Konsultasi" class="login-logo">
        <h2 class="mt-2 justify-content-center">Sistem Konsultasi Mahasiswa</h2>
        <p class="text-muted mb-4">Silakan masuk untuk melanjutkan ke dashboard.</p>
        <div class="mb-3 text-start"><label for="emailInput" class="form-label">Email</label><input type="email" id="emailInput" class="form-control" placeholder="Masukkan email Anda" autocomplete="email"></div>
        <div class="mb-3 text-start"><label for="passwordInput" class="form-label">Password</label><input type="password" id="passwordInput" class="form-control" placeholder="Masukkan password Anda" autocomplete="current-password"></div>
        <button id="btnMasuk" class="btn btn-primary w-100 mt-3" disabled><i class="bi bi-box-arrow-in-right"></i> Masuk</button>
        <div id="loginSpinner" class="text-center mt-3" style="display:none;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>
      </div>

      <!-- ================================================================= -->
      <!-- BAGIAN YANG DIPERBAIKI (Dashboard Mahasiswa) -->
      <!-- ================================================================= -->
      <div id="mahasiswaView" class="content-card">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-person-fill"></i> Dashboard Mahasiswa</h2>
            <div class="d-flex align-items-center">
                <span id="userInfoMahasiswa"></span>
                <button class="btn btn-outline-danger btn-sm ms-3 logout-button"><i class="bi bi-box-arrow-right m-0"></i></button>
            </div>
        </div>
        <hr>
        <div class="row g-5">
            <div class="col-lg-5">
                <h3 class="mt-4"><i class="bi bi-pencil-square"></i> Mulai Konsultasi Baru</h3>
                 <form id="formKonsultasi">
                    <div class="row g-3">
                        <div class="col-12"><input type="text" id="judulKonsultasi" class="form-control" placeholder="Judul / Topik Konsultasi" required></div>
                        <div class="col-12"><select id="dosenTujuan" class="form-select" required><option value="" disabled selected>Pilih Dosen Tujuan...</option></select></div>
                        <div class="col-12"><textarea id="pesanPertama" class="form-control" rows="5" placeholder="Tuliskan pertanyaan atau pesan pertama Anda di sini..." required></textarea></div>
                        <div class="col-12"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="isAnonim"><label class="form-check-label" for="isAnonim">Kirim sebagai Anonim</label></div></div>
                        <div class="col-12"><button type="submit" class="btn btn-primary w-100"><i class="bi bi-send-check"></i> Mulai Konsultasi</button></div>
                    </div>
                 </form>
            </div>
            <div class="col-lg-7">
                <h3 class="mt-4"><i class="bi bi-chat-dots-fill"></i> Daftar Konsultasi Anda</h3>
                <div id="konsultasiListMahasiswa" class="list-group">
                    <div class="text-center p-5"><div class="spinner-border"></div></div>
                </div>
            </div>
        </div>
      </div>

      <!-- DASHBOARD DOSEN (Tidak ada perubahan struktur) -->
      <div id="dosenView" class="content-card">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-person-video3"></i> Dashboard Dosen Konsultan</h2>
            <div class="d-flex align-items-center">
                <span id="userInfoDosen"></span>
                <button class="btn btn-outline-danger btn-sm ms-3 logout-button"><i class="bi bi-box-arrow-right m-0"></i></button>
            </div>
        </div>
        <hr>
        <div class="row g-4 my-4">
            <div class="col-md-4 col-12"><div class="stat-card"><i class="bi bi-journal-check stat-icon"></i><div id="dosenTotalCount" class="stat-value">...</div><div class="stat-label">Total Konsultasi</div></div></div>
            <div class="col-md-4 col-6"><div class="stat-card"><i class="bi bi-hourglass-split stat-icon" style="color: var(--warning-color);"></i><div id="dosenAktifCount" class="stat-value">...</div><div class="stat-label">Aktif</div></div></div>
            <div class="col-md-4 col-6"><div class="stat-card"><i class="bi bi-x-circle-fill stat-icon" style="color: var(--danger-color);"></i><div id="dosenDitutupCount" class="stat-value">...</div><div class="stat-label">Ditutup</div></div></div>
        </div>
        <hr>
        <h3><i class="bi bi-list-task"></i> Daftar Konsultasi</h3>
        <div id="konsultasiListDosen" class="list-group">
            <div class="text-center p-5"><div class="spinner-border"></div></div>
        </div>
      </div>

      <!-- ================================================================= -->
      <!-- BAGIAN YANG DIPERBAIKI (Dashboard Admin) -->
      <!-- ================================================================= -->
      <div id="adminView" class="content-card">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-person-gear"></i> Dashboard Admin</h2>
            <div class="d-flex align-items-center"><span id="userInfoAdmin"></span><button class="btn btn-outline-danger btn-sm ms-3 logout-button"><i class="bi bi-box-arrow-right m-0"></i></button></div>
        </div> <hr>
        <p class="text-muted">Ringkasan aktivitas sistem dan manajemen data master.</p>
        <div class="card admin-sub-card mb-5"><div class="card-body p-4"><div class="row g-4">
            <div class="col-lg-8">
                <h3 class="mt-2"><i class="bi bi-bar-chart-line-fill"></i> Statistik Keseluruhan</h3>
                <div class="row g-3">
                    <div class="col-sm-6"><div class="stat-card clickable h-100" onclick="showArsipKonsultasi()"><i class="bi bi-archive-fill stat-icon"></i><div id="arsipCount" class="stat-value">...</div><div class="stat-label">Total Konsultasi Ditutup</div></div></div>
                    <div class="col-sm-6"><div class="stat-card h-100"><i class="bi bi-people-fill stat-icon"></i><div id="totalUserCount" class="stat-value">...</div><div class="stat-label">Total User Terdaftar</div></div></div>
                </div>
                <h4 class="mt-4 h5 text-center text-muted">Rekapan Aktivitas</h4>
                <div class="row g-3">
                    <div class="col-lg-4"><div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Topik</th><th>Jumlah</th></tr></thead><tbody id="rekapTopik"></tbody></table></div></div>
                    <div class="col-lg-4"><div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Mahasiswa</th><th>Jumlah</th></tr></thead><tbody id="rekapMahasiswa"></tbody></table></div></div>
                    <div class="col-lg-4"><div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Dosen</th><th>Aktif</th><th>Tutup</th></tr></thead><tbody id="rekapDosen"></tbody></table></div></div>
                </div>
            </div>
            <div class="col-lg-4">
                <h3 class="mt-2"><i class="bi bi-tools"></i> Alat Admin</h3>
                <div class="list-group"><button type="button" class="list-group-item list-group-item-action" onclick="openUserModal(null, 'MAHASISWA')"><i class="bi bi-person-plus-fill me-2"></i> Tambah Mahasiswa</button><button type="button" class="list-group-item list-group-item-action" onclick="openUserModal(null, 'DOSEN')"><i class="bi bi-person-video3 me-2"></i> Tambah Dosen</button></div>
                <h3 class="mt-4"><i class="bi bi-box-seam"></i> Backup Data</h3>
                <div class="list-group"><button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="handleBackup(this)"><span><i class="bi bi-database-down me-2"></i> Backup Seluruh Data (JSON)</span><span class="spinner-border spinner-border-sm d-none"></span></button></div>
                <div class="card bg-light border-warning mt-4"><div class="card-body">
                    <h5 class="card-title text-warning-emphasis"><i class="bi bi-exclamation-triangle-fill"></i> Restore Data</h5>
                    <p class="card-text small">Tindakan ini akan menimpa seluruh data. Gunakan dengan hati-hati.</p>
                    <form id="restoreForm"><div class="input-group"><input type="file" class="form-control form-control-sm" id="restoreFile" accept=".json" required><button class="btn btn-sm btn-warning" type="submit"><i class="bi bi-database-up"></i></button></div></form>
                </div></div>
            </div>
        </div></div></div>
        <div class="row g-4">
            <div class="col-lg-12">
                <div class="card admin-sub-card h-100">
                    <div class="card-body p-4">
                        <h3 class="mb-4"><i class="bi bi-people-fill"></i> Manajemen User</h3>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nama</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Topik (Dosen)</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="userList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </main>

    <footer class="app-footer"><div class="container-fluid text-center"><p class="mb-0">&copy; <span id="currentYear"></span> Sistem Informasi Konsultasi. All Rights Reserved.</p></div></footer>
    
    <!-- MODALS -->
    <div class="modal fade" id="arsipModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content" style="border-radius: 1rem;"><div class="modal-header bg-light"><h5 class="modal-title h2"><i class="bi bi-archive-fill me-2"></i> Arsip Konsultasi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="arsipContent" style="background-color: var(--light-bg); padding: 1.5rem;"></div></div></div></div>
    <div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content" style="border-radius: 1rem;"><form id="userForm"><div class="modal-header bg-light"><h5 class="modal-title h2" id="userModalLabel"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="userId" name="userId"><input type="hidden" id="userRole" name="userRole"><div class="mb-3"><label for="userNama" class="form-label">Nama Lengkap</label><input type="text" class="form-control" id="userNama" name="nama" required></div><div class="mb-3"><label for="userEmail" class="form-label">Email</label><input type="email" class="form-control" id="userEmail" name="email" required></div><div class="mb-3"><label for="userPassword" class="form-label">Password</label><input type="password" class="form-control" id="userPassword" name="password"><small class="form-text text-muted">Isi untuk menambah/mengubah. Kosongkan jika tidak ingin mengubah.</small></div><div class="mb-3"><label class="form-label">Topik Konsultasi (untuk Dosen)</label><div id="userTopikCheckboxes" class="p-2 border rounded" style="max-height: 150px; overflow-y: auto;"></div><small class="form-text text-muted">Pilih satu atau lebih topik yang relevan.</small></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Simpan</button></div></form></div></div></div>
    
    <div class="modal fade" id="chatModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content" style="border-radius: 1rem;">
      <div class="modal-header bg-light">
        <h5 class="modal-title h2" id="chatModalTitle"><i class="bi bi-chat-right-text-fill me-2"></i> Konsultasi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <div id="chatBody" class="chat-body">
            <div class="text-center p-5"><div class="spinner-border"></div></div>
        </div>
      </div>
      <div class="modal-footer">
          <div id="chatInputArea" class="w-100">
              <form id="formPesan" class="input-group">
                  <input type="text" id="pesanInput" class="form-control" placeholder="Ketik pesan Anda..." required>
                  <button class="btn btn-primary" type="submit"><i class="bi bi-send-fill"></i> Kirim</button>
              </form>
          </div>
          <div id="chatClosedInfo" class="alert alert-danger w-100 text-center" style="display:none;">Konsultasi ini telah ditutup.</div>
          <button id="closeKonsultasiBtn" type="button" class="btn btn-danger" style="display: none;"><i class="bi bi-x-circle"></i> Tutup Konsultasi</button>
      </div>
    </div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // SCRIPT URL Anda
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwG5To4YXULfxKCohDzUtG9DNS6NcM9VaPTRyif_2a9OtVBU18ZaEn_FAq8oGuxJ23n/exec';
      
      let userModalInstance, arsipModalInstance, chatModalInstance;
      let allTopikList = []; 
      let currentKonsultasiId = null;
      let currentUser = null;
      
      async function callApi(action, payload, method = 'POST') {
        const spinner = document.getElementById("loginSpinner");
        if(spinner) spinner.style.display = 'block';
        try {
          const options = { method, redirect: 'follow', headers: { 'Content-Type': 'text/plain;charset=utf-8' } };
          let url = SCRIPT_URL;
          if (method === 'POST') {
              options.body = JSON.stringify({ action, payload });
          } else {
              const params = new URLSearchParams(payload);
              params.append('action', action);
              url = `${SCRIPT_URL}?${params.toString()}`;
          }
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (error) {
          console.error("API call failed:", {action, payload, error});
          alert("Terjadi kesalahan koneksi ke server. Silakan cek konsol dan coba lagi.");
          throw error;
        } finally {
            if(spinner) spinner.style.display = 'none';
        }
      }
      
      document.addEventListener("DOMContentLoaded", function() {
        const mainContainer = document.getElementById("mainContainer");
        const bodyEl = document.body;
        const views = { loginView: document.getElementById("loginView"), mahasiswaView: document.getElementById("mahasiswaView"), dosenView: document.getElementById("dosenView"), adminView: document.getElementById("adminView") };
        
        function showView(viewName) {
            Object.values(views).forEach(v => { if (v) v.style.display = 'none'; });
            if(views[viewName]) {
                views[viewName].style.display = 'block';
                const isLogin = viewName === 'loginView';
                mainContainer.className = isLogin ? 'container-login' : 'container-fluid py-4';
                bodyEl.style.alignItems = isLogin ? 'center' : 'flex-start';
            }
        }
        
        userModalInstance = new bootstrap.Modal(document.getElementById('userModal'));
        arsipModalInstance = new bootstrap.Modal(document.getElementById('arsipModal'));
        chatModalInstance = new bootstrap.Modal(document.getElementById('chatModal'));
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        currentUser = JSON.parse(sessionStorage.getItem("loggedInUser"));
        if (currentUser) {
          showDashboard(currentUser);
        } else {
          showView("loginView");
          setupLoginValidation();
        }

        document.getElementById("btnMasuk").addEventListener("click", handleMasuk);
        document.querySelectorAll(".logout-button").forEach(btn => btn.addEventListener("click", handleLogout));
        document.getElementById("formKonsultasi")?.addEventListener("submit", handleSubmitKonsultasi);
        document.getElementById("userForm")?.addEventListener("submit", handleUserFormSubmit);
        document.getElementById("restoreForm")?.addEventListener("submit", handleRestoreSubmit);
        document.getElementById("formPesan")?.addEventListener("submit", handleSendMessage);
        document.getElementById("closeKonsultasiBtn")?.addEventListener("click", handleCloseKonsultasi);
        
        function setupLoginValidation() {
          const emailInput = document.getElementById("emailInput");
          const passwordInput = document.getElementById("passwordInput");
          const btnMasuk = document.getElementById("btnMasuk");
          const validate = () => { btnMasuk.disabled = !(emailInput.value.trim() && passwordInput.value.trim()); };
          emailInput.addEventListener("input", validate);
          passwordInput.addEventListener("input", validate);
          validate();
        }

        async function handleMasuk() {
            const email = document.getElementById("emailInput").value;
            const password = document.getElementById("passwordInput").value;
            if (!email || !password) return;
            document.getElementById("btnMasuk").disabled = true;
            try {
              const response = await callApi('loginUser', { loginData: { email, password } });
              if(response.success){
                  sessionStorage.setItem("loggedInUser", JSON.stringify(response.user));
                  currentUser = response.user;
                  showDashboard(response.user);
              } else {
                  alert(response.message || "Login gagal.");
              }
            } finally {
              document.getElementById("btnMasuk").disabled = false;
            }
        }

        function handleLogout() {
          sessionStorage.removeItem("loggedInUser");
          currentUser = null;
          location.reload();
        }
        
        async function showDashboard(user) {
          const roleBadge = `<span class="badge rounded-pill role-badge">${user.role}</span>`;
          const userInfoHtml = `Halo, <strong>${user.nama}</strong> ${roleBadge}`;
          if (user.role === "MAHASISWA") {
            showView("mahasiswaView");
            document.getElementById('userInfoMahasiswa').innerHTML = userInfoHtml;
            await loadDosenListForMahasiswa();
            await loadKonsultasiListMahasiswa(user.userId);
          } else if (user.role === "DOSEN") {
            showView("dosenView");
            document.getElementById('userInfoDosen').innerHTML = userInfoHtml;
            await loadDosenDashboard(user);
          } else if (user.role === "ADMIN") {
            showView("adminView");
            document.getElementById('userInfoAdmin').innerHTML = userInfoHtml;
            await loadAdminDashboard();
          }
        }
        
        async function loadTopikListFromServer() {
           if (allTopikList.length === 0) {
             allTopikList = await callApi('getTopikList', {}, 'GET') || [];
           }
        }
        
        // FUNGSI BARU: untuk mengambil dan menampilkan daftar dosen di form mahasiswa
        async function loadDosenListForMahasiswa() {
            const dosenSelect = document.getElementById('dosenTujuan');
            dosenSelect.innerHTML = '<option value="" disabled selected>Memuat daftar dosen...</option>';
            const dosenList = await callApi('getDosenList', {}, 'GET');
            if(dosenList && dosenList.length > 0) {
                dosenSelect.innerHTML = '<option value="" disabled selected>Pilih Dosen Tujuan...</option>';
                dosenList.forEach(d => {
                    dosenSelect.innerHTML += `<option value="${d.userId}">${d.nama}</option>`;
                });
            } else {
                dosenSelect.innerHTML = '<option value="" disabled selected>Tidak ada dosen yang terdaftar.</option>';
            }
        }

        async function handleSubmitKonsultasi(e) {
          e.preventDefault();
          const konsultasiData = {
              judul_konsultasi: document.getElementById("judulKonsultasi").value,
              id_dosen_tujuan: document.getElementById("dosenTujuan").value,
              pesan_pertama: document.getElementById("pesanPertama").value,
              is_anonim: document.getElementById("isAnonim").checked,
              id_mahasiswa_pengaju: currentUser.userId
          };
          
          if (!konsultasiData.id_dosen_tujuan) {
            return alert("Dosen tujuan wajib dipilih.");
          }

          const submitBtn = e.target.querySelector('button[type="submit"]');
          submitBtn.disabled = true; 
          submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Mengirim...`;
          
          try {
            const response = await callApi('submitKonsultasi', { konsultasiData });
            alert(response.message);
            if (response.success) {
              e.target.reset();
              loadKonsultasiListMahasiswa(currentUser.userId);
            }
          } finally {
            submitBtn.disabled = false; 
            submitBtn.innerHTML = `<i class="bi bi-send-check"></i> Mulai Konsultasi`;
          }
        }
        
        async function loadKonsultasiListMahasiswa(mahasiswaId) {
            const container = document.getElementById("konsultasiListMahasiswa");
            container.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';
            const list = await callApi('getKonsultasiListByMahasiswa', { mahasiswaId }, 'GET');
            
            if (!list || list.length === 0) {
              container.innerHTML = '<div class="alert alert-light text-center border">Anda belum pernah memulai konsultasi.</div>';
              return;
            }
            container.innerHTML = list.slice().reverse().map(k => `
              <a href="#" class="list-group-item list-group-item-action" onclick="openChat('${k.id_konsultasi}')">
                <div class="d-flex w-100 justify-content-between">
                  <h5 class="mb-1">${k.judul_konsultasi}</h5>
                  <small>${new Date(k.tgl_diajukan).toLocaleDateString()}</small>
                </div>
                <p class="mb-1">Dosen: ${k.nama_dosen_tujuan}</p>
                ${k.status === 'AKTIF' ? '<span class="badge bg-success">Aktif</span>' : '<span class="badge bg-danger">Ditutup</span>'}
                ${k.is_anonim ? '<span class="badge bg-secondary ms-2">Anonim</span>' : ''}
              </a>`).join('');
        }
        
        async function loadDosenDashboard(user) {
            const stats = await callApi('getDosenStats', { dosenId: user.userId }, 'GET');
            if (stats) {
                document.getElementById("dosenTotalCount").textContent = stats.totalDitangani;
                document.getElementById("dosenAktifCount").textContent = stats.aktif;
                document.getElementById("dosenDitutupCount").textContent = stats.ditutup;
            }
            const container = document.getElementById("konsultasiListDosen");
            container.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';
            const list = await callApi('getKonsultasiListForDosen', { dosenId: user.userId }, 'GET');

            if (!list || list.length === 0) {
              container.innerHTML = '<div class="alert alert-info text-center"><i class="bi bi-emoji-sunglasses"></i> Tidak ada konsultasi yang ditujukan untuk Anda.</div>';
              return;
            }
             container.innerHTML = list.slice().reverse().map(k => `
              <a href="#" class="list-group-item list-group-item-action" onclick="openChat('${k.id_konsultasi}')">
                <div class="d-flex w-100 justify-content-between">
                  <h5 class="mb-1">${k.judul_konsultasi}</h5>
                  <small>Dari: <strong>${k.nama_mahasiswa_pengaju}</strong></small>
                </div>
                <p class="mb-1">Diajukan: ${new Date(k.tgl_diajukan).toLocaleDateString()}</p>
                ${k.status === 'AKTIF' ? '<span class="badge bg-warning text-dark">Aktif - Perlu Respon</span>' : '<span class="badge bg-secondary">Ditutup</span>'}
              </a>`).join('');
        }
        
        window.openChat = async function(konsultasiId) {
            currentKonsultasiId = konsultasiId;
            chatModalInstance.show();
            const chatBody = document.getElementById('chatBody');
            chatBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';
            
            const data = await callApi('getKonsultasiDetail', { konsultasiId, userId: currentUser.userId }, 'GET');
            if (data.error) {
                chatBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            renderChat(data);
        }

        function renderChat(data) {
            const { thread, pesan } = data;
            document.getElementById('chatModalTitle').innerHTML = `<i class="bi bi-chat-right-text-fill me-2"></i> ${thread.judul_konsultasi}`;
            const chatBody = document.getElementById('chatBody');
            
            chatBody.innerHTML = pesan.map(p => {
                const isSender = p.id_pengirim.toString() === currentUser.userId.toString();
                const senderName = isSender ? 'Anda' : p.nama_pengirim;
                return `
                    <div class="chat-message ${isSender ? 'sender' : 'receiver'}">
                        <div class="message-content">
                            <div>${p.isi_pesan}</div>
                            <div class="message-meta">${senderName} &bull; ${new Date(p.timestamp).toLocaleString()}</div>
                        </div>
                    </div>`;
            }).join('');
            
            chatBody.scrollTop = chatBody.scrollHeight;

            const isClosed = thread.status === 'DITUTUP';
            document.getElementById('chatInputArea').style.display = isClosed ? 'none' : 'block';
            document.getElementById('chatClosedInfo').style.display = isClosed ? 'block' : 'none';
            document.getElementById('closeKonsultasiBtn').style.display = currentUser.role === 'DOSEN' && !isClosed ? 'block' : 'none';
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            const input = document.getElementById("pesanInput");
            const isi_pesan = input.value.trim();
            if (!isi_pesan || !currentKonsultasiId) return;
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            input.disabled = true;

            const pesanData = { id_konsultasi: currentKonsultasiId, id_pengirim: currentUser.userId, isi_pesan };
            const response = await callApi('submitPesan', { pesanData });
            if (response.success) {
                input.value = '';
                const updatedData = await callApi('getKonsultasiDetail', { konsultasiId: currentKonsultasiId, userId: currentUser.userId }, 'GET');
                renderChat(updatedData);
            } else {
                alert(response.message || 'Gagal mengirim pesan.');
            }
            submitBtn.disabled = false;
            input.disabled = false;
            input.focus();
        }

        async function handleCloseKonsultasi() {
            if (!currentKonsultasiId || !confirm("Apakah Anda yakin ingin menutup konsultasi ini? Tindakan ini tidak dapat dibatalkan.")) return;
            const response = await callApi('closeKonsultasi', { konsultasiId: currentKonsultasiId });
            alert(response.message);
            if(response.success) {
                chatModalInstance.hide();
                loadDosenDashboard(currentUser);
            }
        }
        
        async function loadAdminDashboard() {
            const data = await callApi('getAdminDashboardData', {}, 'GET');
            if (data) {
                allTopikList = data.topik || [];
                populateAdminStats(data.stats, data.users);
                populateUserTables(data.users);
            }
        }

        function populateAdminStats(stats, users) {
          if (!stats) return;
          document.getElementById('arsipCount').textContent = stats.arsipCount || 0;
          document.getElementById('totalUserCount').textContent = (users || []).length;
          
          const renderTable = (tbodyId, data, limit = 5) => {
            const tbody = document.getElementById(tbodyId);
            const entries = Object.entries(data).sort(([,a],[,b]) => b - a).slice(0, limit);
            tbody.innerHTML = entries.length > 0 ? entries.map(([key, value]) => `<tr><td>${key.split(" ")[0]}</td><td>${value}</td></tr>`).join('') : `<tr><td colspan="2" class="text-center text-muted">-</td></tr>`;
          };

          renderTable('rekapMahasiswa', stats.konsultasiPerMahasiswa || {});
          renderTable('rekapTopik', stats.konsultasiPerTopik || {});
          
          const rekapDosenBody = document.getElementById('rekapDosen');
          const dosenEntries = Object.values(stats.konsultasiPerDosen || {}).sort((a,b) => (b.aktif + b.ditutup) - (a.aktif + a.ditutup));
          rekapDosenBody.innerHTML = dosenEntries.length > 0 ? dosenEntries.map(d => `<tr><td>${d.nama.split(" ")[0]}</td><td>${d.aktif}</td><td>${d.ditutup}</td></tr>`).join('') : '<tr><td colspan="3" class="text-center text-muted">-</td></tr>';
        }

        function populateUserTables(users) {
            if (!users) return;
            const userListBody = document.getElementById('userList');
            userListBody.innerHTML = users.map(user => {
                const topikBadges = (user.topik || '').split(',').filter(Boolean).map(p => `<span class="badge bg-secondary me-1">${p}</span>`).join('') || '-';
                return `<tr><td>${user.nama}</td><td>${user.email || '-'}</td><td><span class="badge bg-info text-dark">${user.role}</span></td><td>${topikBadges}</td>
                  <td><button class="btn btn-sm btn-outline-primary py-1 px-2" onclick='openUserModal(${JSON.stringify(user)}, "${user.role}")'><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-sm btn-outline-danger py-1 px-2" onclick="handleDeleteUser('${user.userId}', '${user.nama}')"><i class="bi bi-trash"></i></button>
                  </td></tr>`;
            }).join('');
        }

        window.openUserModal = async function(user, role) {
          const form = document.getElementById('userForm');
          form.reset();
          await loadTopikListFromServer();
          document.getElementById('userRole').value = role;
          const label = document.getElementById('userModalLabel');
          label.innerHTML = `<i class="bi ${role === 'MAHASISWA' ? 'bi-person-plus-fill' : 'bi-person-video3'} me-2"></i> ${user ? 'Edit' : 'Tambah'} ${role.charAt(0) + role.slice(1).toLowerCase()}`;
          const checkboxContainer = document.getElementById('userTopikCheckboxes');
          checkboxContainer.innerHTML = '';
          const userTopik = user ? (user.topik || '').split(',') : [];
          allTopikList.forEach(p => {
              checkboxContainer.innerHTML += `<div class="form-check"><input class="form-check-input" type="checkbox" value="${p.id}" id="topik_check_${p.id}" ${userTopik.includes(p.id.toString()) ? 'checked' : ''}><label class="form-check-label" for="topik_check_${p.id}">${p.nama} (${p.id})</label></div>`;
          });
          if (user) {
            document.getElementById('userId').value = user.userId;
            document.getElementById('userNama').value = user.nama;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPassword').required = false;
            document.getElementById('userPassword').placeholder = "Kosongkan jika tidak diubah";
          } else {
            document.getElementById('userId').value = '';
            document.getElementById('userPassword').required = true;
            document.getElementById('userPassword').placeholder = "";
          }
          userModalInstance.show();
        }
        
        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const selectedTopik = Array.from(document.querySelectorAll('#userTopikCheckboxes .form-check-input:checked')).map(cb => cb.value).join(',');
            const userData = {
                userId: e.target.userId.value, nama: e.target.userNama.value, email: e.target.userEmail.value,
                role: e.target.userRole.value, password: e.target.userPassword.value, topik: selectedTopik,
            };
            const action = userData.userId ? 'updateUser' : 'addUser';
            if(action === 'addUser' && !userData.password) return alert("Password wajib diisi untuk user baru.");
            const response = await callApi(action, { userData });
            alert(response.message);
            if(response.success) { userModalInstance.hide(); loadAdminDashboard(); }
        }
        
        window.handleDeleteUser = async function(userId, userName) {
            if (confirm(`Yakin ingin menghapus user "${userName}"?`)) {
                const response = await callApi('deleteUser', { userId });
                alert(response.message);
                if (response.success) loadAdminDashboard();
            }
        }
        
        window.handleBackup = async function(button) {
            const spinner = button.querySelector('.spinner-border');
            spinner.classList.remove('d-none'); button.disabled = true;
            try {
                const response = await callApi('backupData', {});
                if(response.success){
                    const filename = `konsultasi_backup_${new Date().toISOString().slice(0, 10)}.json`;
                    const blob = new Blob([response.backupData], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = window.URL.createObjectURL(blob);
                    a.download = filename;
                    a.click();
                    window.URL.revokeObjectURL(a.href);
                } else { alert(response.message || 'Backup gagal'); }
            } finally { spinner.classList.add('d-none'); button.disabled = false; }
        }

        async function handleRestoreSubmit(e) {
            e.preventDefault();
            const fileInput = document.getElementById('restoreFile');
            const file = fileInput.files[0];
            if(!file) return alert("Pilih file backup (.json).");
            if (prompt("PERINGATAN! Ini akan MENGGANTI SEMUA data yang ada. Ketik 'RESTORE' untuk melanjutkan.") !== 'RESTORE') {
              fileInput.value = ''; return alert("Proses restore dibatalkan.");
            }
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const backupData = JSON.parse(event.target.result);
                    const response = await callApi('restoreData', { backupData });
                    alert(response.message);
                    if(response.success) location.reload();
                } catch (err) { alert("Gagal memproses file backup: " + err.message); }
            };
            reader.readAsText(file);
        }

        window.showArsipKonsultasi = async function() {
            const modalBody = document.getElementById('arsipContent');
            modalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div>';
            arsipModalInstance.show();
            const list = await callApi('getArsipKonsultasi', {}, 'GET');
            if (!list || list.length === 0) {
              modalBody.innerHTML = '<div class="alert alert-info text-center m-3">Arsip konsultasi masih kosong.</div>'; return;
            }
            modalBody.innerHTML = list.slice().reverse().map(k => `
              <div class="card mb-3"><div class="card-header d-flex justify-content-between"><span>Konsultasi dari: <strong>${k.nama_mahasiswa_pengaju}</strong> kepada <strong>${k.nama_dosen_tujuan}</strong></span><span class="badge bg-danger">DITUTUP</span></div>
              <div class="card-body"><h6 class="card-subtitle mb-2 text-muted">Judul: ${k.judul_konsultasi}</h6></div></div>`).join('');
        }
      });
    </script>
  </body>
</html>
